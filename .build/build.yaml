
apiVersion: builds.katanomi.dev/v1alpha1
kind: Build
spec:
  workspaces:
    - description: >
        This workspace is shared among all the pipeline tasks to read/write
        common resources
      name: source
  tasks:
    - name: version
      timeout: 5m
      retries: 1
      workspaces:
        - name: source
          workspace: source
      taskRef:
        kind: ClusterTask
        name: alauda-generate-version
      params:
        - name: repo-type
          value: gitlab
        - name: repo-url
          value: $(params.git-url)
        - name: repo-ref
          value: $(params.git-revision)
    - name: build-controller
      runAfter:
        - version
      timeout: 30m
      retries: 3
      taskRef:
        kind: ClusterTask
        name: alauda-build-image
      workspaces:
        - name: source
          workspace: source
      params:
        - name: container-image
          value: build-harbor.alauda.cn/3rdparty/metallb/controller
        - name: container-image-tag
          value: "v0.13.4-alauda.$(tasks.version.results.timestamp)"
        - name: dockerfile
          value: ./controller/Dockerfile
        - name: labels
          value: []
        - name: context
          value: .
        - name: build-extra-args
          value: ""
        - name: platform
          value:
            - linux/amd64
            - linux/arm64
        - name: tags
          value: []
        - name: tools-image
          value: registry.alauda.cn:60080/devops/builder-tools:v3.8-0-g377a3f9
        - name: verbose
          value: "true"
    - name: build-speaker
      runAfter:
        - version
      timeout: 30m
      retries: 3
      taskRef:
        kind: ClusterTask
        name: alauda-build-image
      workspaces:
        - name: source
          workspace: source
      params:
        - name: container-image
          value: build-harbor.alauda.cn/3rdparty/metallb/speaker
        - name: container-image-tag
          value: "v0.13.4-alauda.$(tasks.version.results.timestamp)"
        - name: dockerfile
          value: ./speaker/Dockerfile
        - name: labels
          value: []
        - name: context
          value: .
        - name: build-extra-args
          value: ""
        - name: platform
          value:
            - linux/amd64
            - linux/arm64
        - name: tags
          value: []
        - name: tools-image
          value: registry.alauda.cn:60080/devops/builder-tools:v3.8-0-g377a3f9
        - name: verbose
          value: "true"
